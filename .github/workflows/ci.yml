name: CI for Ingestion

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with ruff
        run: |
          ruff check .

      - name: Build Docker image
        run: |
          docker build -t eurostat-trade-pipeline:ci .

      # Smoke test only: run inside the built image without network downloads.
      # DRY_RUN ensures no data is fetched; this validates wiring and exits fast.
      - name: Smoke test in Docker (no downloads)
        run: |
          docker run --rm \
            -e DRY_RUN=1 \
            eurostat-trade-pipeline:ci \
            bash -lc 'bash src/bronze/comext_download.sh 2002-11 2002-11 && bash src/bronze/comext_extract.sh || true'

      # Static analysis for bash scripts (common pitfalls, not formatting).
      - name: ShellCheck (bash scripts)
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck src/bronze/*.sh